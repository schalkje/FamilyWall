@using FamilyWall.Core.Models

<div class="event-details-panel @(IsOpen ? "open" : "")">
    <div class="panel-overlay" @onclick="Close"></div>

    <div class="panel-content">
        @if (Event != null)
        {
            <div class="panel-header" style="border-left: 4px solid @(Event.Calendar?.Color ?? "#3788D8")">
                <div class="event-title-section">
                    <h2>@Event.Title</h2>
                    @if (Event.IsBirthday)
                    {
                        <span class="birthday-badge">üéÇ Birthday</span>
                    }
                    @if (Event.IsRecurring)
                    {
                        <span class="recurring-badge">üîÑ Recurring</span>
                    }
                </div>
                <button class="close-btn" @onclick="Close">‚úï</button>
            </div>

            <div class="panel-body">
                <!-- Calendar Badge -->
                <div class="detail-section">
                    <div class="calendar-badge" style="border-left-color: @(Event.Calendar?.Color ?? "#3788D8")">
                        <span class="dot" style="background-color: @(Event.Calendar?.Color ?? "#3788D8")"></span>
                        <span class="calendar-name">@(Event.Calendar?.Name ?? "Unknown Calendar")</span>
                    </div>
                </div>

                <!-- Date & Time -->
                <div class="detail-section">
                    <div class="detail-row">
                        <div class="detail-icon">üìÖ</div>
                        <div class="detail-content">
                            <div class="detail-label">Date</div>
                            <div class="detail-value">@Event.StartUtc.ToLocalTime().ToString("dddd, MMMM d, yyyy")</div>
                        </div>
                    </div>

                    @if (!Event.IsAllDay)
                    {
                        <div class="detail-row">
                            <div class="detail-icon">‚è∞</div>
                            <div class="detail-content">
                                <div class="detail-label">Time</div>
                                <div class="detail-value">
                                    @Event.StartUtc.ToLocalTime().ToString("h:mm tt")
                                    @if (Event.EndUtc.HasValue)
                                    {
                                        <span> - @Event.EndUtc.Value.ToLocalTime().ToString("h:mm tt")</span>
                                        <span class="duration">(@GetDuration())</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="detail-row">
                            <div class="detail-icon">üïê</div>
                            <div class="detail-content">
                                <div class="detail-label">Duration</div>
                                <div class="detail-value">All Day Event</div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Location -->
                @if (!string.IsNullOrEmpty(Event.Location))
                {
                    <div class="detail-section">
                        <div class="detail-row">
                            <div class="detail-icon">üìç</div>
                            <div class="detail-content">
                                <div class="detail-label">Location</div>
                                <div class="detail-value">@Event.Location</div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Online Meeting -->
                @if (!string.IsNullOrEmpty(Event.OnlineMeetingUrl))
                {
                    <div class="detail-section">
                        <div class="detail-row">
                            <div class="detail-icon">üîó</div>
                            <div class="detail-content">
                                <div class="detail-label">Online Meeting</div>
                                <div class="detail-value">
                                    <a href="@Event.OnlineMeetingUrl" target="_blank" class="meeting-link">
                                        Join Meeting
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Organizer -->
                @if (!string.IsNullOrEmpty(Event.Organizer))
                {
                    <div class="detail-section">
                        <div class="detail-row">
                            <div class="detail-icon">üë§</div>
                            <div class="detail-content">
                                <div class="detail-label">Organizer</div>
                                <div class="detail-value">@Event.Organizer</div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Attendees -->
                @if (Event.Attendees != null && Event.Attendees.Any())
                {
                    <div class="detail-section">
                        <div class="detail-row">
                            <div class="detail-icon">üë•</div>
                            <div class="detail-content">
                                <div class="detail-label">Attendees (@Event.Attendees.Count)</div>
                                <div class="attendees-list">
                                    @foreach (var attendee in Event.Attendees.Take(5))
                                    {
                                        <div class="attendee-item">
                                            <span class="attendee-avatar">üë§</span>
                                            <span class="attendee-name">@attendee</span>
                                        </div>
                                    }
                                    @if (Event.Attendees.Count > 5)
                                    {
                                        <div class="more-attendees">
                                            +@(Event.Attendees.Count - 5) more
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Response Status -->
                @if (Event.ResponseStatus.HasValue)
                {
                    <div class="detail-section">
                        <div class="detail-row">
                            <div class="detail-icon">@GetResponseIcon(Event.ResponseStatus.Value)</div>
                            <div class="detail-content">
                                <div class="detail-label">Your Response</div>
                                <div class="detail-value">
                                    <span class="response-badge @GetResponseClass(Event.ResponseStatus.Value)">
                                        @Event.ResponseStatus.Value.ToString()
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Description -->
                @if (!string.IsNullOrEmpty(Event.Description))
                {
                    <div class="detail-section">
                        <div class="detail-row">
                            <div class="detail-icon">üìù</div>
                            <div class="detail-content">
                                <div class="detail-label">Description</div>
                                <div class="detail-value description-text">@Event.Description</div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Status -->
                <div class="detail-section">
                    <div class="detail-row">
                        <div class="detail-icon">‚ÑπÔ∏è</div>
                        <div class="detail-content">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge @GetStatusClass(Event.Status)">
                                    @Event.Status.ToString()
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metadata -->
                <div class="detail-section metadata-section">
                    <div class="metadata-row">
                        <span class="metadata-label">Source:</span>
                        <span class="metadata-value">@Event.Source</span>
                    </div>
                    @if (Event.LastSyncUtc.HasValue)
                    {
                        <div class="metadata-row">
                            <span class="metadata-label">Last synced:</span>
                            <span class="metadata-value">@Event.LastSyncUtc.Value.ToLocalTime().ToString("g")</span>
                        </div>
                    }
                    <div class="metadata-row">
                        <span class="metadata-label">Created:</span>
                        <span class="metadata-value">@Event.CreatedUtc.ToLocalTime().ToString("g")</span>
                    </div>
                </div>
            </div>

            <div class="panel-footer">
                <button class="btn-close" @onclick="Close">Close</button>
            </div>
        }
    </div>
</div>

<style>
    .event-details-panel {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .event-details-panel.open {
        pointer-events: all;
        opacity: 1;
    }

    .panel-overlay {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: rgba(0, 0, 0, 0.5);
    }

    .panel-content {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 500px;
        max-width: 90vw;
        background: white;
        box-shadow: -4px 0 16px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        transform: translateX(100%);
        transition: transform 0.3s;
    }

    .event-details-panel.open .panel-content {
        transform: translateX(0);
    }

    .panel-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        background: #f9f9f9;
    }

    .event-title-section {
        flex: 1;
        min-width: 0;
    }

    .event-title-section h2 {
        margin: 0 0 0.5rem 0;
        font-size: 1.5rem;
        line-height: 1.3;
    }

    .birthday-badge, .recurring-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 0.5rem;
    }

    .birthday-badge {
        background: #FFE0E0;
        color: #C62828;
    }

    .recurring-badge {
        background: #E3F2FD;
        color: #1976D2;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        padding: 0.25rem;
        line-height: 1;
        transition: color 0.2s;
        margin-left: 1rem;
    }

    .close-btn:hover {
        color: #333;
    }

    .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem 2rem;
    }

    .detail-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #f0f0f0;
    }

    .detail-section:last-child {
        border-bottom: none;
    }

    .calendar-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid #e0e0e0;
        border-left: 3px solid;
        border-radius: 6px;
        font-weight: 600;
    }

    .calendar-badge .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .detail-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .detail-row:last-child {
        margin-bottom: 0;
    }

    .detail-icon {
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .detail-content {
        flex: 1;
        min-width: 0;
    }

    .detail-label {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .detail-value {
        font-size: 1rem;
        color: #333;
        line-height: 1.5;
    }

    .duration {
        color: #666;
        font-size: 0.9rem;
        margin-left: 0.5rem;
    }

    .meeting-link {
        color: #2196F3;
        text-decoration: none;
        font-weight: 600;
    }

    .meeting-link:hover {
        text-decoration: underline;
    }

    .attendees-list {
        margin-top: 0.5rem;
    }

    .attendee-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f5f5f5;
    }

    .attendee-avatar {
        font-size: 1.2rem;
    }

    .attendee-name {
        font-size: 0.9rem;
    }

    .more-attendees {
        padding: 0.5rem 0;
        color: #666;
        font-size: 0.9rem;
        font-style: italic;
    }

    .response-badge, .status-badge {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .response-badge.accepted {
        background: #E8F5E9;
        color: #2E7D32;
    }

    .response-badge.declined {
        background: #FFEBEE;
        color: #C62828;
    }

    .response-badge.tentative {
        background: #FFF9C4;
        color: #F57F17;
    }

    .response-badge.notresponded {
        background: #F5F5F5;
        color: #666;
    }

    .status-badge.confirmed {
        background: #E8F5E9;
        color: #2E7D32;
    }

    .status-badge.tentative {
        background: #FFF9C4;
        color: #F57F17;
    }

    .status-badge.cancelled {
        background: #FFEBEE;
        color: #C62828;
    }

    .description-text {
        white-space: pre-wrap;
        line-height: 1.6;
    }

    .metadata-section {
        background: #f9f9f9;
        padding: 1rem;
        border-radius: 6px;
    }

    .metadata-row {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
        font-size: 0.8rem;
    }

    .metadata-label {
        color: #666;
    }

    .metadata-value {
        color: #333;
        font-weight: 500;
    }

    .panel-footer {
        padding: 1rem 2rem;
        border-top: 1px solid #e0e0e0;
        background: #f9f9f9;
    }

    .btn-close {
        width: 100%;
        padding: 0.75rem;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-close:hover {
        background: #f5f5f5;
        border-color: #2196F3;
    }
</style>

@code {
    [Parameter]
    public bool IsOpen { get; set; }

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public CalendarEvent? Event { get; set; }

    private async Task Close()
    {
        await IsOpenChanged.InvokeAsync(false);
    }

    private string GetDuration()
    {
        if (Event?.EndUtc == null) return "";

        var duration = Event.EndUtc.Value - Event.StartUtc;

        if (duration.TotalMinutes < 60)
            return $"{(int)duration.TotalMinutes} min";

        if (duration.TotalHours < 24)
        {
            var hours = (int)duration.TotalHours;
            var minutes = (int)(duration.TotalMinutes % 60);
            return minutes > 0 ? $"{hours}h {minutes}m" : $"{hours}h";
        }

        return $"{(int)duration.TotalDays} days";
    }

    private string GetResponseIcon(EventResponseStatus status)
    {
        return status switch
        {
            EventResponseStatus.Accepted => "‚úì",
            EventResponseStatus.Declined => "‚úó",
            EventResponseStatus.Tentative => "?",
            _ => "‚óã"
        };
    }

    private string GetResponseClass(EventResponseStatus status)
    {
        return status.ToString().ToLower();
    }

    private string GetStatusClass(EventStatus status)
    {
        return status.ToString().ToLower();
    }
}
